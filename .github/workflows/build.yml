name: Build iOS Tweak

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Theos
      run: |
        echo "=== Installing Theos ==="
        git clone --quiet --recursive https://github.com/theos/theos.git ~/theos
        echo "Theos cloned to: ~/theos"
        ls -la ~/theos
    
    - name: Download iOS SDKs
      run: |
        echo "=== Downloading iOS SDKs ==="
        cd ~/theos
        curl -sL https://github.com/theos/sdks/archive/master.zip -o sdks.zip
        echo "Extracting SDKs..."
        unzip -q sdks.zip
        ls -la
        mv sdks-master/* sdks/ 2>/dev/null || true
        rm -rf sdks-master sdks.zip
        echo "SDKs installed:"
        ls -la sdks/ | head -20
    
    - name: Verify Theos Setup
      run: |
        echo "=== Theos Verification ==="
        export THEOS=~/theos
        echo "THEOS: $THEOS"
        echo "Theos bin:"
        ls -la $THEOS/bin/ | head -10
        echo "Theos makefiles:"
        ls -la $THEOS/makefiles/
        echo "Theos SDKs:"
        ls -la $THEOS/sdks/ | head -10
    
    - name: Build FateMod
      run: |
        echo "=== Building FateMod ==="
        export THEOS=~/theos
        export THEOS_MAKE_PATH=$THEOS/makefiles
        export PATH="$THEOS/bin:$PATH"
        echo "THEOS: $THEOS"
        echo "THEOS_MAKE_PATH: $THEOS_MAKE_PATH"
        echo "PATH: $PATH"
        echo "Working directory: $(pwd)"
        echo "Files in workspace:"
        ls -la
        echo ""
        echo "=== Running make package ==="
        make package FINALPACKAGE=1 2>&1
      working-directory: ${{ github.workspace }}
      continue-on-error: true
    
    - name: Check build output
      if: always()
      run: |
        echo "=== Build Artifacts ==="
        if [ -d "packages" ]; then
          echo "Packages directory:"
          ls -la packages/
        else
          echo "No packages directory found"
        fi
        
        echo ""
        echo "=== Theos Build Directory ==="
        if [ -d ".theos" ]; then
          echo ".theos directory:"
          find .theos -type f -name "*.o" -o -name "*.dylib" 2>/dev/null | head -20
        fi
    
    - name: Upload .deb artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: FateMod-${{ github.ref_name }}
        path: packages/*.deb
        retention-days: 30
    
    - name: Upload build logs on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs-${{ github.run_id }}
        path: |
          .theos/
          *.log
        retention-days: 7
